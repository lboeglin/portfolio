---
import Layout from '@layouts/MainLayout.astro';
import ProjectCard from '@components/ProjectCard.astro';
import { getCollection } from 'astro:content';
import { useTranslations } from '@i18n/utils';
import { type Lang, defaultLang } from '@i18n/ui';

const currentLang = (Astro.currentLocale || defaultLang) as Lang;
const t = useTranslations(currentLang);

const allProjects = await getCollection('projects');

const filteredProjects = allProjects.filter((project) => {
  return project.slug.startsWith(`${currentLang}/`);
});

const sortedProjects = filteredProjects.sort(
  (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

const title = t('nav.projects');
---

<Layout title={`${title} - Lohan BoÃ«glin`}>
  <section class="animate-in fade-in slide-in-from-bottom-4 duration-700">
    <h1 class="text-4xl font-bold mb-8">{title}</h1>

    <div role="tablist" class="tabs tabs-boxed mb-10 w-fit bg-base-200/50 p-1 gap-1">
      <button
        role="tab"
        data-tab="all"
        class="tab tab-active transition-all duration-300 data-[active=true]:bg-primary data-[active=true]:text-primary-content rounded-lg"
        onclick="setCategory('all', this)">{t('projects.filter.all')}</button
      >
      <button
        role="tab"
        data-tab="personal"
        class="tab transition-all duration-300 data-[active=true]:bg-primary data-[active=true]:text-primary-content rounded-lg"
        onclick="setCategory('personal', this)">{t('projects.filter.personal')}</button
      >
      <button
        role="tab"
        data-tab="academic"
        class="tab transition-all duration-300 data-[active=true]:bg-primary data-[active=true]:text-primary-content rounded-lg"
        onclick="setCategory('academic', this)">{t('projects.filter.academic')}</button
      >
    </div>

    <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
      {
        sortedProjects.map((project, index) => (
          <div
            class={`project-item ${index >= 6 ? 'hidden' : ''}`}
            data-category={project.data.category}
          >
            <ProjectCard project={project} />
          </div>
        ))
      }
    </div>

    <div id="no-projects" class="hidden py-20 text-center opacity-50">
      <p class="text-xl">{t('projects.empty')}</p>
    </div>

    <div class="flex justify-center">
      <button id="load-more-btn" class="btn btn-outline min-w-50 hidden" onclick="loadMore()">
        {t('projects.loadMore')}
      </button>
    </div>
  </section>
</Layout>

<script is:inline>
  // Configuration
  let currentCategory = 'all';
  let itemsToShow = 6;
  const itemsIncrement = 6;

  // Runs on initial load AND after View Transitions (language switch)
  document.addEventListener('astro:page-load', () => {
    // 1. Recover state from localStorage (default to 'all' if empty)
    currentCategory = localStorage.getItem('selectedCategory') || 'all';
    itemsToShow = 6;

    // 2. Update the UI Tabs to match the recovered category
    updateActiveTab(currentCategory);

    // 3. Render
    renderProjects();
  });

  function updateActiveTab(category) {
    // Reset all tabs
    document.querySelectorAll('[role="tab"]').forEach((el) => {
      el.classList.remove('tab-active', 'bg-primary', 'text-primary-content');
      el.removeAttribute('data-active');
    });

    // Find the correct tab using the data attribute and activate it
    const activeBtn = document.querySelector(`[data-tab="${category}"]`);
    if (activeBtn) {
      activeBtn.classList.add('tab-active', 'bg-primary', 'text-primary-content');
      activeBtn.setAttribute('data-active', 'true');
    }
  }

  function setCategory(category, btn) {
    // Save to storage
    localStorage.setItem('selectedCategory', category);

    currentCategory = category;
    itemsToShow = itemsIncrement; // Reset pagination when switching tabs

    updateActiveTab(category);
    renderProjects();
  }

  function loadMore() {
    itemsToShow += itemsIncrement;
    renderProjects();
  }

  function renderProjects() {
    const allItems = document.querySelectorAll('.project-item');
    const emptyState = document.getElementById('no-projects');
    const loadMoreBtn = document.getElementById('load-more-btn');

    let visibleCount = 0;
    let matchCount = 0;

    allItems.forEach((item) => {
      const itemCategory = item.getAttribute('data-category');
      const isMatch = currentCategory === 'all' || itemCategory === currentCategory;

      if (isMatch) {
        matchCount++;
        if (visibleCount < itemsToShow) {
          item.classList.remove('hidden');
          // Only animate if it was previously hidden
          if (item.style.display === 'none' || item.classList.contains('hidden')) {
            // Simple fade in
            item.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 300 });
          }
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      } else {
        item.classList.add('hidden');
      }
    });

    if (matchCount === 0) {
      emptyState.classList.remove('hidden');
    } else {
      emptyState.classList.add('hidden');
    }

    if (matchCount > itemsToShow) {
      loadMoreBtn.classList.remove('hidden');
    } else {
      loadMoreBtn.classList.add('hidden');
    }
  }
</script>
