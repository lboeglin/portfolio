---
import type { CollectionEntry } from 'astro:content';
import { useTranslations } from '../i18n/utils';
import { type Lang, defaultLang } from '@i18n/ui';
import SoftBadge from './SoftBadge.astro';

const { experiences } = Astro.props as {
  experiences: CollectionEntry<'experiences'>[];
};

const currentLang = (Astro.currentLocale || defaultLang) as Lang;

const base = import.meta.env.BASE_URL;

const t = useTranslations(currentLang);

function formatDate(dateStr?: string) {
  if (!dateStr) return t('experiences.present');
  const date = new Date(dateStr + '-01');
  return new Intl.DateTimeFormat(currentLang, { month: 'short', year: 'numeric' }).format(date);
}
---

<section id="professional">
  <h2 class="text-3xl font-bold mb-8 border-b pb-2">
    {t('experiences.section')}
  </h2>

  <ol class="relative border-l border-base-300 pl-6 space-y-12">
    {
      experiences.map((exp) => (
        <li>
          <span class="absolute -left-2 w-4 h-4 bg-primary rounded-full" />

          <div class="flex flex-col gap-2">
            <div class="flex flex-wrap items-baseline gap-2">
              <h3 class="text-xl font-bold">{exp.data.title}</h3>
              <span class="opacity-70">
                @{' '}
                {exp.data.companyUrl ? (
                  <a
                    href={exp.data.companyUrl}
                    target="_blank"
                    rel="noopener"
                    class="animated-link hover:text-primary"
                  >
                    {exp.data.company}
                  </a>
                ) : (
                  exp.data.company
                )}
              </span>
            </div>

            <div class="flex flex-wrap items-center gap-2 text-sm opacity-70">
              <span>
                {formatDate(exp.data.startDate)} â€” {formatDate(exp.data.endDate)}
              </span>

              <span class="badge badge-primary badge-outline badge-sm">
                {t(`experiences.type.${exp.data.type}` as any)}
              </span>
            </div>

            {exp.data.highlights?.length ? (
              <ul class="list-disc list-inside text-sm leading-relaxed opacity-90">
                {exp.data.highlights.map((point: string) => (
                  <li>{point}</li>
                ))}
              </ul>
            ) : (
              <div class="prose max-w-none">{exp.body}</div>
            )}

            <div class="flex flex-wrap gap-2 pt-3">
              {exp.data.stack.map((tech: string) => (
                <SoftBadge name={tech} />
              ))}
            </div>

            {(exp.data.repo || exp.data.report) && (
              <div class="flex gap-4 pt-2 text-sm">
                {exp.data.repo && (
                  <a
                    class="animated-link flex items-center gap-1 opacity-80 hover:opacity-100 hover:text-primary"
                    href={exp.data.repo}
                    target="_blank"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4" />
                      <path d="M9 18c-4.51 2-5-2-7-2" />
                    </svg>
                    {t('experiences.repo')}
                  </a>
                )}
                {exp.data.report && (
                  <a
                    class="animated-link flex items-center gap-1 opacity-80 hover:opacity-100 hover:text-primary"
                    href={`${base}/${exp.data.report}`}
                    target="_blank"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                      <polyline points="14 2 14 8 20 8" />
                      <line x1="16" y1="13" x2="8" y2="13" />
                      <line x1="16" y1="17" x2="8" y2="17" />
                      <polyline points="10 9 9 9 8 9" />
                    </svg>
                    {t('experiences.report')}
                  </a>
                )}
              </div>
            )}
          </div>
        </li>
      ))
    }
  </ol>
</section>
