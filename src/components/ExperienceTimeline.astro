---
import type { CollectionEntry } from 'astro:content';

type Lang = 'fr' | 'en';

const { experiences, lang = 'fr' } = Astro.props as {
  experiences: CollectionEntry<'experiences'>[];
  lang?: Lang;
};

// Translation labels
const labels = {
  fr: {
    section: 'Expériences Professionnelles',
    present: 'Présent',
    repo: 'Dépôt de code',
    report: 'Rapport de stage',
    locale: 'fr-FR',
  },
  en: {
    section: 'Professional Experiences',
    present: 'Present',
    repo: 'Code repository',
    report: 'Internship report',
    locale: 'en-US',
  },
} as const;

const typeLabels = {
  fr: {
    Internship: 'Stage',
    Apprenticeship: 'Alternance',
  },
  en: {
    Internship: 'Internship',
    Apprenticeship: 'Apprenticeship',
  },
} as const;

const t = labels[lang];

function formatDate(dateStr?: string) {
  if (!dateStr) return t.present;
  const date = new Date(dateStr + '-01');
  return new Intl.DateTimeFormat(t.locale, { month: 'short', year: 'numeric' }).format(date);
}
---

<section id="professional">
  <h2 class="text-3xl font-bold mb-8 border-b pb-2">{t.section}</h2>

  <ol class="relative border-l border-base-300 pl-6 space-y-12">
    {
      experiences.map((exp) => (
        <li>
          <span class="absolute -left-2 w-4 h-4 bg-primary rounded-full" />

          <div class="flex flex-col gap-2">
            <div class="flex flex-wrap items-baseline gap-2">
              <h3 class="text-xl font-bold">{exp.data.title}</h3>
              <span class="opacity-70">
                @{' '}
                {exp.data.companyUrl ? (
                  <a href={exp.data.companyUrl} target="_blank" rel="noopener">
                    {exp.data.company}
                  </a>
                ) : (
                  exp.data.company
                )}
              </span>
            </div>

            <div class="text-sm opacity-60">
              {formatDate(exp.data.startDate)} — {formatDate(exp.data.endDate)} ·{' '}
              {typeLabels[lang][exp.data.type]}
            </div>

            {/* Render highlights if available, otherwise fallback to Markdown body */}
            {exp.data.highlights?.length ? (
              <ul class="list-disc list-inside prose max-w-none">
                {exp.data.highlights.map((point: string) => (
                  <li>{point}</li>
                ))}
              </ul>
            ) : (
              <div class="prose max-w-none">{exp.body}</div>
            )}

            <div class="flex flex-wrap gap-2 pt-2">
              {exp.data.stack.map((tech: string) => (
                <span class="badge badge-outline badge-sm">{tech}</span>
              ))}
            </div>

            {(exp.data.repo || exp.data.report) && (
              <div class="text-sm opacity-70 flex gap-4 mt-2">
                {exp.data.repo && (
                  <a href={exp.data.repo} target="_blank" rel="noopener">
                    {t.repo}
                  </a>
                )}
                {exp.data.report && (
                  <a href={exp.data.report} target="_blank">
                    {t.report}
                  </a>
                )}
              </div>
            )}
          </div>
        </li>
      ))
    }
  </ol>
</section>
